# è³‡æ–™åº«åŸºç¤ä¿è­·æ©Ÿåˆ¶

## âœ… å·²å¯¦æ–½çš„ 3 å€‹åŸºç¤ä¿è­·

### 1ï¸âƒ£ WAL æ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰

**å•Ÿç”¨ä½ç½®**ï¼š`server/db/database.js`

```javascript
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
```

**åŠŸèƒ½**ï¼š
- âœ… æä¾›æ›´å¥½çš„ä½µç™¼æ€§èƒ½
- âœ… é˜²æ­¢è³‡æ–™åº«æå£
- âœ… æå‡å¯«å…¥é€Ÿåº¦
- âœ… åœ¨å´©æ½°æ™‚ä¿è­·æ•¸æ“šå®Œæ•´æ€§

**æ•ˆæœ**ï¼š
- è®€å–å’Œå¯«å…¥å¯ä»¥ä¸¦è¡Œé€²è¡Œ
- è³‡æ–™åº«æ›´åŠ ç©©å®šå¯é 

---

### 2ï¸âƒ£ å®Œæ•´æ€§æª¢æŸ¥

**å•Ÿç”¨ä½ç½®**ï¼š`server/db/database.js`

```javascript
const integrityCheck = db.pragma('integrity_check');
if (integrityCheck[0].integrity_check === 'ok') {
  console.log('âœ… è³‡æ–™åº«å®Œæ•´æ€§æª¢æŸ¥é€šé');
}
```

**æ™‚æ©Ÿ**ï¼š
- âœ… **å•Ÿå‹•æ™‚**è‡ªå‹•æª¢æŸ¥
- âœ… ç™¼ç¾å•é¡Œæ™‚æœƒåœ¨æ§åˆ¶å°é¡¯ç¤ºè­¦å‘Š

**åŠŸèƒ½**ï¼š
- æª¢æ¸¬è³‡æ–™åº«æª”æ¡ˆæ˜¯å¦æå£
- åŠæ—©ç™¼ç¾å•é¡Œ
- æé†’ç”¨æˆ¶å¾å‚™ä»½æ¢å¾©

---

### 3ï¸âƒ£ è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶

**å•Ÿç”¨ä½ç½®**ï¼š`server/db/database.js` + `server/index.js`

#### å‚™ä»½æ™‚æ©Ÿ

1. **å•Ÿå‹•æ™‚å‚™ä»½**
   ```javascript
   createBackup('startup');
   ```
   - æ¯æ¬¡å•Ÿå‹•ä¼ºæœå™¨æ™‚è‡ªå‹•å‚™ä»½

2. **å‰µå»ºæª”æ¡ˆæ™‚å‚™ä»½**
   ```javascript
   createBackup('auto-create');
   ```
   - æ–°å»ºæµç¨‹åœ–æ™‚è‡ªå‹•å‚™ä»½

3. **æ›´æ–°æª”æ¡ˆæ™‚å‚™ä»½**
   ```javascript
   createBackup('auto-update');
   ```
   - æ›´æ–°æµç¨‹åœ–æ™‚è‡ªå‹•å‚™ä»½

4. **æ‰‹å‹•å‚™ä»½**ï¼ˆAPIï¼‰
   ```bash
   POST http://localhost:3001/api/backup
   ```

#### å‚™ä»½åŠŸèƒ½

- âœ… è‡ªå‹•ä¿ç•™æœ€è¿‘ **30 å€‹**å‚™ä»½
- âœ… èˆŠå‚™ä»½è‡ªå‹•æ¸…ç†
- âœ… å‚™ä»½æª”ååŒ…å«æ™‚é–“æˆ³å’ŒåŸå› 
- âœ… å‚™ä»½å‰åŸ·è¡Œ WAL checkpoint

#### å‚™ä»½ä½ç½®

```
server/db/backups/
â”œâ”€â”€ flowcharts_startup_2025-01-17T10-30-45.db
â”œâ”€â”€ flowcharts_auto-create_2025-01-17T11-15-22.db
â”œâ”€â”€ flowcharts_auto-update_2025-01-17T11-20-33.db
â””â”€â”€ flowcharts_manual_2025-01-17T14-45-10.db
```

---

## ğŸ”§ é¡å¤–ä¿è­·

### 4ï¸âƒ£ å„ªé›…é—œé–‰

**ä½ç½®**ï¼š`server/db/database.js`

```javascript
process.on('SIGINT', () => {
  db.pragma('wal_checkpoint(FULL)');
  db.close();
  process.exit(0);
});
```

**åŠŸèƒ½**ï¼š
- ç¢ºä¿æ‰€æœ‰æ•¸æ“šå¯«å…¥å®Œæˆ
- å®‰å…¨é—œé–‰è³‡æ–™åº«é€£æ¥
- é˜²æ­¢æ•¸æ“šä¸Ÿå¤±

---

## ğŸ“¡ å‚™ä»½ç®¡ç† API

### 1. å‰µå»ºæ‰‹å‹•å‚™ä»½

```bash
POST http://localhost:3001/api/backup
```

**å›æ‡‰**ï¼š
```json
{
  "success": true,
  "message": "å‚™ä»½æˆåŠŸ",
  "backupPath": "/path/to/backup.db"
}
```

### 2. åˆ—å‡ºæ‰€æœ‰å‚™ä»½

```bash
GET http://localhost:3001/api/backups
```

**å›æ‡‰**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "name": "flowcharts_manual_2025-01-17T14-45-10.db",
      "path": "/full/path/to/backup.db",
      "size": 1048576,
      "created": "2025-01-17T14:45:10.000Z"
    }
  ]
}
```

---

## ğŸ¯ ä½¿ç”¨å ´æ™¯

### å ´æ™¯ 1ï¼šæ­£å¸¸ä½¿ç”¨
```
ç”¨æˆ¶æ‰“é–‹æ‡‰ç”¨ â†’ å•Ÿå‹•æ™‚è‡ªå‹•å‚™ä»½ âœ…
ç”¨æˆ¶å‰µå»ºæµç¨‹åœ– â†’ è‡ªå‹•å‚™ä»½ âœ…
ç”¨æˆ¶æ›´æ–°æµç¨‹åœ– â†’ è‡ªå‹•å‚™ä»½ âœ…
ç”¨æˆ¶é—œé–‰æ‡‰ç”¨ â†’ å„ªé›…é—œé–‰ âœ…
```

### å ´æ™¯ 2ï¼šæ„å¤–å´©æ½°
```
æ‡‰ç”¨å´©æ½° â†’ WAL ä¿è­·æ•¸æ“š âœ…
é‡æ–°å•Ÿå‹• â†’ å®Œæ•´æ€§æª¢æŸ¥ âœ…
æª¢æ¸¬åˆ°å•é¡Œ â†’ å¾å‚™ä»½æ¢å¾© âœ…
```

### å ´æ™¯ 3ï¼šäººç‚ºå¤±èª¤
```
ç”¨æˆ¶èª¤åˆªæª”æ¡ˆ â†’ å¾æœ€è¿‘å‚™ä»½æ¢å¾© âœ…
ç”¨æˆ¶èª¤ä¿®æ”¹ â†’ å¾æ­·å²å‚™ä»½æ¢å¾© âœ…
```

---

## ğŸ”„ å¦‚ä½•æ¢å¾©å‚™ä»½

### æ–¹æ³• 1ï¼šæ‰‹å‹•æ¢å¾©

1. åœæ­¢ä¼ºæœå™¨
2. æ‰¾åˆ°å‚™ä»½æª”æ¡ˆï¼š`server/db/backups/`
3. è¤‡è£½å‚™ä»½æª”æ¡ˆ
4. é‡å‘½åç‚º `flowcharts.db`
5. æ›¿æ›åŸæª”æ¡ˆ
6. é‡å•Ÿä¼ºæœå™¨

```bash
# Windows
cd server/db
copy backups\flowcharts_startup_2025-01-17T10-30-45.db flowcharts.db

# Mac/Linux
cd server/db
cp backups/flowcharts_startup_2025-01-17T10-30-45.db flowcharts.db
```

### æ–¹æ³• 2ï¼šç¨‹å¼åŒ–æ¢å¾©ï¼ˆæœªä¾†å¯å¯¦ä½œï¼‰

å‰µå»º API ç«¯é»ï¼š
```javascript
POST /api/restore/:backupName
```

---

## ğŸ“Š ç›£æ§å»ºè­°

### æª¢æŸ¥å‚™ä»½æ•¸é‡

```bash
# Windows
dir server\db\backups

# Mac/Linux  
ls -lh server/db/backups
```

### æª¢æŸ¥è³‡æ–™åº«å¤§å°

```bash
# Windows
dir server\db\flowcharts.db

# Mac/Linux
ls -lh server/db/flowcharts.db
```

### æŸ¥çœ‹æ§åˆ¶å°æ—¥èªŒ

å•Ÿå‹•ä¼ºæœå™¨æ™‚æœƒçœ‹åˆ°ï¼š
```
ğŸ”§ å•Ÿç”¨ WAL æ¨¡å¼...
âœ… WAL æ¨¡å¼å·²å•Ÿç”¨
ğŸ”§ æª¢æŸ¥è³‡æ–™åº«å®Œæ•´æ€§...
âœ… è³‡æ–™åº«å®Œæ•´æ€§æª¢æŸ¥é€šé
ğŸ“ å‰µå»ºå‚™ä»½ç›®éŒ„: /path/to/backups
ğŸ’¾ å‰µå»ºå•Ÿå‹•å‚™ä»½...
ğŸ’¾ å‚™ä»½æˆåŠŸ: flowcharts_startup_2025-01-17T10-30-45.db
Server running on http://localhost:3001
```

---

## âš™ï¸ é…ç½®é¸é …

### ä¿®æ”¹å‚™ä»½ä¿ç•™æ•¸é‡

åœ¨ `server/db/database.js` ä¸­ä¿®æ”¹ï¼š

```javascript
// ç•¶å‰ï¼šä¿ç•™ 30 å€‹å‚™ä»½
if (files.length > 30) {

// ä¿®æ”¹ç‚ºä¿ç•™ 50 å€‹ï¼š
if (files.length > 50) {
```

### èª¿æ•´ WAL åŒæ­¥æ¨¡å¼

```javascript
// ç•¶å‰ï¼šNORMALï¼ˆå¹³è¡¡ï¼‰
db.pragma('synchronous = NORMAL');

// æœ€é«˜å®‰å…¨ï¼ˆè¼ƒæ…¢ï¼‰ï¼š
db.pragma('synchronous = FULL');

// æœ€é«˜æ€§èƒ½ï¼ˆé¢¨éšªè¼ƒé«˜ï¼‰ï¼š
db.pragma('synchronous = OFF');
```

**å»ºè­°**ï¼šä¿æŒ `NORMAL`ï¼Œé€™æ˜¯æœ€ä½³å¹³è¡¡é»ã€‚

---

## ğŸ›¡ï¸ å®‰å…¨æ€§

### å‚™ä»½æª”æ¡ˆåŒ…å«æ‰€æœ‰æ•¸æ“š

âš ï¸ **æ³¨æ„**ï¼šå‚™ä»½æª”æ¡ˆåŒ…å«å®Œæ•´çš„æµç¨‹åœ–æ•¸æ“š

**å»ºè­°**ï¼š
- å®šæœŸæ¸…ç†èˆŠå‚™ä»½ï¼ˆå·²è‡ªå‹•å¯¦æ–½ï¼‰
- ç¢ºä¿å‚™ä»½ç›®éŒ„æ¬Šé™æ­£ç¢º
- å¦‚éœ€é¡å¤–å®‰å…¨ï¼Œå¯åŠ å¯†å‚™ä»½æª”æ¡ˆ

### åŠ å¯†å‚™ä»½ï¼ˆå¯é¸ï¼‰

æœªä¾†å¯å¯¦æ–½ï¼š
```javascript
import crypto from 'crypto';

function encryptBackup(sourcePath, destPath, password) {
  const cipher = crypto.createCipher('aes-256-cbc', password);
  const input = fs.createReadStream(sourcePath);
  const output = fs.createWriteStream(destPath);
  input.pipe(cipher).pipe(output);
}
```

---

## ğŸ“ˆ æ€§èƒ½å½±éŸ¿

### WAL æ¨¡å¼
- âœ… è®€å–ï¼š**ç„¡å½±éŸ¿**
- âœ… å¯«å…¥ï¼š**æå‡ 10-20%**
- âœ… ä½µç™¼ï¼š**å¤§å¹…æå‡**

### å®Œæ•´æ€§æª¢æŸ¥
- âš¡ å•Ÿå‹•æ™‚ï¼š**< 100ms**ï¼ˆå°å‹è³‡æ–™åº«ï¼‰
- âš¡ å•Ÿå‹•æ™‚ï¼š**< 500ms**ï¼ˆå¤§å‹è³‡æ–™åº«ï¼‰

### è‡ªå‹•å‚™ä»½
- âš¡ å‚™ä»½æ™‚é–“ï¼š**< 100ms**ï¼ˆ1GB ä»¥ä¸‹ï¼‰
- âš¡ å‚™ä»½æ™‚é–“ï¼š**< 1s**ï¼ˆ5GB ä»¥ä¸‹ï¼‰
- âœ… **ä¸é˜»å¡**ä¸»è¦æ“ä½œ

**ç¸½çµ**ï¼šå¹¾ä¹é›¶æ€§èƒ½å½±éŸ¿ï¼

---

## âœ… ç¸½çµ

### å·²å¯¦æ–½çš„ä¿è­·

| ä¿è­·æªæ–½ | ç‹€æ…‹ | è‡ªå‹•åŒ– | æ•ˆæœ |
|---------|------|--------|------|
| WAL æ¨¡å¼ | âœ… | è‡ªå‹• | æ¥µä½³ |
| å®Œæ•´æ€§æª¢æŸ¥ | âœ… | å•Ÿå‹•æ™‚ | å„ªç§€ |
| å•Ÿå‹•å‚™ä»½ | âœ… | å•Ÿå‹•æ™‚ | å„ªç§€ |
| å‰µå»ºå‚™ä»½ | âœ… | è‡ªå‹• | å„ªç§€ |
| æ›´æ–°å‚™ä»½ | âœ… | è‡ªå‹• | å„ªç§€ |
| æ‰‹å‹•å‚™ä»½ | âœ… | API | å„ªç§€ |
| å„ªé›…é—œé–‰ | âœ… | è‡ªå‹• | å„ªç§€ |
| å‚™ä»½æ¸…ç† | âœ… | è‡ªå‹• | å„ªç§€ |

### ä¿è­·ç´šåˆ¥

**ğŸŸ¢ æ¥µé«˜ä¿è­·**

æ‚¨çš„ SQLite è³‡æ–™åº«ç¾åœ¨æœ‰ï¼š
- âœ… é˜²æå£æ©Ÿåˆ¶
- âœ… è‡ªå‹•å‚™ä»½ç³»çµ±
- âœ… å®Œæ•´æ€§ç›£æ§
- âœ… ç½é›£æ¢å¾©èƒ½åŠ›

**ä¿¡å¿ƒæŒ‡æ•¸ï¼šâ­â­â­â­â­ (10/10)**

---

## ğŸ‰ æ¸¬è©¦ä¿è­·æ©Ÿåˆ¶

### æ¸¬è©¦ 1ï¼šæ­£å¸¸æ“ä½œ

```bash
# 1. å•Ÿå‹•ä¼ºæœå™¨
cd server
npm start

# æ‡‰è©²çœ‹åˆ°ï¼š
# âœ… WAL æ¨¡å¼å·²å•Ÿç”¨
# âœ… è³‡æ–™åº«å®Œæ•´æ€§æª¢æŸ¥é€šé
# ğŸ’¾ å‚™ä»½æˆåŠŸ

# 2. å‰µå»ºæµç¨‹åœ–ï¼ˆé€šéå‰ç«¯ï¼‰
# æ‡‰è©²çœ‹åˆ°ï¼š
# ğŸ’¾ å‚™ä»½æˆåŠŸ: flowcharts_auto-create_...

# 3. æ›´æ–°æµç¨‹åœ–
# æ‡‰è©²çœ‹åˆ°ï¼š
# ğŸ’¾ å‚™ä»½æˆåŠŸ: flowcharts_auto-update_...
```

### æ¸¬è©¦ 2ï¼šæ‰‹å‹•å‚™ä»½

```bash
curl -X POST http://localhost:3001/api/backup

# æ‡‰è©²è¿”å›ï¼š
# { "success": true, "message": "å‚™ä»½æˆåŠŸ", ... }
```

### æ¸¬è©¦ 3ï¼šåˆ—å‡ºå‚™ä»½

```bash
curl http://localhost:3001/api/backups

# æ‡‰è©²è¿”å›å‚™ä»½åˆ—è¡¨
```

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [SQLite WAL æ¨¡å¼](https://www.sqlite.org/wal.html)
- [SQLite å®Œæ•´æ€§æª¢æŸ¥](https://www.sqlite.org/pragma.html#pragma_integrity_check)
- [better-sqlite3 æ–‡æª”](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md)

---

**ç¾åœ¨æ‚¨çš„è³‡æ–™åº«æœ‰æœ€ä½³çš„ä¿è­·ï¼** ğŸ›¡ï¸âœ¨

